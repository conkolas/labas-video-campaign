function render(e){e?(requestId=requestAnimationFrame(render),targetStep!=step&&(isTablet?targetStep>step?step+=Math.round(Math.sqrt(targetStep-step)):step-=Math.round(Math.sqrt(step-targetStep)):targetStep>step?step++:step--),changeFrame(),isMobile||step>=seqEndStep-1&&!seqEndCalled&&"function"==typeof seqEndCallback&&(seqEndCalled=!0,seqEndCallback())):window.cancelAnimationFrame(requestId)}function changeFrame(){var e=Math.round(step);"undefined"!=typeof images[currentSeq-1]&&"undefined"!=typeof images[currentSeq-1][e]&&context&&(context.fillStyle=images[currentSeq-1][e],context.fill())}function changeCanvas(e){context=contexts[e],bufferCanvas=bufferCanvases[e],bufferContext=bufferContexts[e]}function setCanvas(e){var t=document.getElementById("seq-"+e);t.width=contentResolution.width,t.height=contentResolution.height,contexts[e]=t.getContext("2d"),contexts[e].rect(0,0,contentResolution.width,contentResolution.height)}function resizeVideo(){var e=$("#video-holder"),t=$("#video-loop"),n=$(".seq-holder"),s=$(window),o=s.width()/s.height(),r=contentResolution.width,i=contentResolution.height,a=r/i;if(a>o)var d=s.height()*a,l=s.height(),c=(d-s.width())/2,u=0;else var d=s.width(),l=s.width()/a,c=0,u=-(l-s.height())/2;l=Math.round(l),d=Math.round(d),c=Math.round(c),u=Math.round(u),e.css({height:l,width:d,left:-c,top:u}),t.css({height:l,width:d,left:-c,top:u}),n.css({height:l,width:d,left:-c,top:u}),contextW=d,contextH=l}function startSequence1(){$(".seq-holder.seq-1").addClass("show"),$(".seq-holder.seq-1 .seq-intro").addClass("show"),seqActive=!0,seqCalled1=!0,seqEndStep=frames[currentSeq-1].endFrame-frames[currentSeq-1].startFrame,render(!0),video.pause(),$(".seq-holder.seq-1 .seq-intro .bottom-line").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-1 .seq-intro").removeClass("show"),$(".seq-holder.seq-1 .seq-intro").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-1 .seq-intro").hide()},300),initSlider()})},800)}),setTimeout(function(){video.currentTime=seqEnd1,video.play(),video.pause()},1e3),seqEndCallback=endSequence1}function startSequence2(){$(".seq-holder.seq-2").addClass("show"),$(".seq-holder.seq-2 .mic-request").addClass("animate"),seqActive=!0,seqCalled2=!0,currentSeq=2,seqEndStep=100,seqEndCallback=endSequence2,video.pause(),$(".seq-holder.seq-2 .skip-text").on("click tap",function(){seqEndCallback=skipSequence2,seqEndCallback(),seqEndCalled=!0,targetStep=seqEndStep}),$(".seq-holder.seq-2 .mic-request .mid-circle").bind("click tap",function(){navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices.getUserMedia),navigator.getUserMedia?navigator.getUserMedia({audio:!0},function(e){$(".seq-holder.seq-2 .mic-request").removeClass("animate"),$(".seq-holder.seq-2 .mic-ui").addClass("animate"),start_microphone(e)},function(e){seqEndCallback=skipSequence2,targetStep=seqEndStep}):(seqEndCallback=skipSequence2,targetStep=seqEndStep)})}function startSequence3(){$(".seq-holder.seq-3").addClass("show"),$(".seq-holder.seq-3 .seq-intro").addClass("show"),seqActive=!0,seqCalled3=!0,currentSeq=3,seqEndStep=frames[currentSeq-1].endFrame-frames[currentSeq-1].startFrame,render(!0),video.pause(),$(".seq-holder.seq-3 .seq-intro .bottom-line").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-3 .seq-intro").removeClass("show"),$(".seq-holder.seq-3 .seq-intro").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-3 .seq-intro").hide()},300),initSlider()})},800)}),setTimeout(function(){video.currentTime=seqEnd3,video.play(),video.pause()},1e3),seqEndCallback=endSequence3}function startSequence4(){var e=!1;$(".seq-holder.seq-4").addClass("show"),$(".seq-holder.seq-4 .phone-button").addClass("animate"),ringtone.volume=.3,ringtone.loop=!0,ringtone.play(),currentSeq=4,video.pause(),seqActive=!0,seqCalled4=!0,seqEndStep=10,seqEndCallback=endSequence4,callAudio.onended=function(){seqEndCallback()},$(".seq-holder.seq-4 .phone-button.button-green").bind("click tap",function(){render(!0),ringtone.pause(),callAudio.play(),$(".seq-holder.seq-4 .phone-button.button-green").unbind("click tap"),$(".seq-holder.seq-4 .phone-button").removeClass("animate"),$(".seq-holder.seq-4 .phone-button").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-4").removeClass("show")},300)})}),$(".seq-holder.seq-4 .phone-button.button-red").bind("click tap",function(){ringtone.pause(),e?(video.currentTime=9.04,video.play(),targetStep=seqEndStep,$(".seq-holder.seq-4 .phone-button.button-red").unbind("click tap"),$(".seq-holder.seq-4 .phone-button").removeClass("animate"),$(".seq-holder.seq-4 .phone-button").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-4").removeClass("show")},300)})):($(".seq-holder.seq-4 .phone-button").removeClass("animate"),$(".seq-holder.seq-4 .phone-button").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-4 .phone-button").addClass("animate").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){ringtone.load(),ringtone.play()})},1e3)}),e=!0)}),video.pause()}function startSequence5(){$(".seq-holder.seq-5").addClass("show"),$(".seq-holder.seq-5 .seq-intro").addClass("show"),seqActive=!0,seqCalled5=!0,currentSeq=5,seqEndStep=10;var e=550,t=550,n=550,s=550,o=[];o[1]=e,o[2]=t,o[3]=n,o[4]=s;var r=1;$(".seq-holder.seq-5 .seq-intro .bottom-line").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){render(!0),setTimeout(function(){$(".seq-holder.seq-5 .seq-intro").removeClass("show"),$(".seq-holder.seq-5 .seq-intro").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){$(".seq-holder.seq-5 .seq-intro").hide(),$(".seq-holder.seq-5 .test-holder").addClass("active"),$(".seq-holder.seq-5 .progress-circle-"+r).addClass("active"),$(".seq-holder.seq-5 .question-"+r).addClass("active"),$(".seq-holder.seq-5 .button").bind("click tap",function(){playingStep||(playStep(r,o),r++)})},300)})},800)}),video.pause(),video.controls=!1,seqEndCallback=endSequence5}function startSequence6(e){if(isTablet&&(video.controls=!1,video.pause()),e){$(".seq-holder.seq-6").addClass("show"),$(".fixed-text-block").fadeOut(),render(!0),currentSeq=1,targetStep=1,seqActive=!0,seqCalled6=!0,mobileSeq[0]=21,mobileSeq[1]=63,mobileSeq[2]=90,mobileSeq[3]=52,mobileSeqStatus[0]=!1,mobileSeqStatus[1]=!1,mobileSeqStatus[2]=!1,mobileSeqStatus[3]=!1,currentStepLength=mobileSeq[currentSeq-1];var t=0;seq=1,$("body").bind("touchend",function(){clearInterval(touchInterval),mobileSeqStatus[currentSeq-1]?currentSeq>=mobileSeq.length-1?$(".seq-6 .mobile-step").fadeOut(500,function(){render(!1)}):(touched=!1,t=0,step=targetStep=t,seq++,currentSeq=seq,currentStepLength=mobileSeq[currentSeq-1]):touchEndIntervalActive||(touchEndIntervalActive=!0,touchEndInterval=setInterval(function(){targetStep>currentStepLength?(currentSeq>=mobileSeq.length-1?$(".seq-6 .mobile-step").fadeOut(500,function(){render(!1)}):(touchEndIntervalActive=!1,mobileSeqStatus[currentSeq-1]=!0,touched=!1,t=0,step=targetStep=t,seq++,currentSeq=seq,currentStepLength=mobileSeq[currentSeq-1]),clearInterval(touchEndInterval)):targetStep>currentStepLength/2?(t++,targetStep=t):0==targetStep?(touched=!1,touchEndIntervalActive=!1,clearInterval(touchEndInterval)):(t--,targetStep=t)},40))}),$(".seq-6 .mid-circle").bind("touchstart",function(e){e.preventDefault(),touched||(touched=!0,touchInterval=setInterval(function(){currentStepLength>targetStep?(targetStep=t,t++):mobileSeqStatus[currentSeq-1]=!0},40))}),seqEndCallback=endSequence6}else $(".seq-holder.seq-6").addClass("show"),$(".fixed-text-block").fadeOut(),seqActive=!0,seqCalled6=!0,currentSeq=6,seqEndStep=10,seqEndCallback=endSequence6}function playStep(e,t){playingStep=!0,video.controls=!1,video.play(),$(".seq-holder.seq-5 .progress-circle-"+e+" circle").attr("style","transition: stroke-dashoffset "+t[e]/1e3+"s ease;"),setStepProgressValue(e,100),$(".seq-holder.seq-5 .progress-circle-"+e+" .progress-bar").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){$(".seq-holder.seq-5 .progress-circle-"+e).removeClass("active").addClass("passed"),$(".seq-holder.seq-5 .question-"+e).addClass("passed").removeClass("active"),$(".seq-holder.seq-5 .progress-circle-"+(e+1)).addClass("active"),$(".seq-holder.seq-5 .question-"+(e+1)).addClass("active"),e==t.length-1?(targetStep=seqEndStep,seqEndCallback()):video.pause(),playingStep=!1})}function setStepProgressValue(e,t){var e=$(".seq-holder.seq-5 .progress-circle-"+e+" .progress-bar"),n=parseInt(e.attr("stroke-dasharray"),10);e.css("stroke-dashoffset",n-Math.round(n/100*t))}function setProgressValue(e,t){var n=t,s=e.find(".svg .bar");if(isNaN(n))n=100;else{var o=s.data("size"),r=s.data("max");s.attr("r"),parseInt(s.attr("stroke-dasharray"));0>n&&(n=0),n>100&&(n=100);var i=r/100*n;0>i&&(i=0),i>r&&(i=r),s.attr("stroke-dasharray",i+","+o)}}function updateMicUI(e){var t=Math.round(e),n=50;t>n&&(t=n),0>t&&(t=0);var s=1;targetVol=t,currentVol=oldMicVol,oldMicVol=t;var o=targetVol-currentVol;0>o&&(s=-1),clearInterval(micUIInterval),micUIInterval=setInterval(function(){currentVol+=s,currentVol>targetVol&&(currentVol=targetVol),0>currentVol&&(currentVol=0),currentVol>=n&&(clearInterval(micUIInterval),stop_microphone()),currentVol>=n?(targetStep=seqEndStep,setProgressValue($(".seq-holder.seq-"+currentSeq+" .progress-circle"),100),$(".seq-holder.seq-"+currentSeq+" .value-circle .value").html(n)):(setProgressValue($(".seq-holder.seq-"+currentSeq+" .progress-circle"),100/n*currentVol),$(".seq-holder.seq-"+currentSeq+" .value-circle .value").html(currentVol))},100/Math.abs(o))}function start_microphone(e){microphone_stream=audioContext.createMediaStreamSource(e),analyserNode=audioContext.createAnalyser(),analyserNode.smoothingTimeConstant=.3,analyserNode.fftSize=1024,microphone_stream.connect(analyserNode),levelChecker=audioContext.createScriptProcessor(4096,1,1);var t=new Uint8Array(1),n=0,s=0,o=0,r=50;analyserNode.connect(levelChecker),microphone_stream.connect(levelChecker),levelChecker.connect(audioContext.destination);var i=null,a=!1;setProgressValue($(".seq-holder.seq-"+currentSeq+" .progress-circle"),0),levelChecker.onaudioprocess=function(e){analyserNode.getByteFrequencyData(t),n=t[0],s=n/255,o=analyserNode.minDecibels+(analyserNode.maxDecibels-analyserNode.minDecibels)*s+Math.abs(analyserNode.minDecibels),a||(a=!0,i=setTimeout(function(){o>=r?updateMicUI(r):(a=!1,updateMicUI(o))},100))}}function stop_microphone(){"undefined"!=typeof audioContext&&"closed"!=audioContext.state&&audioContext.close(),levelChecker=null}function initSlider(){var e=1==currentSeq?360:750,t=1==currentSeq?73:82,n=1==currentSeq?117:98;$(".seq-holder.seq-"+currentSeq+" .slider").roundSlider({sliderType:"min-range",circleShape:"full",min:0,max:100,value:0,showTooltip:!1,keyboardAction:!1,startAngle:t,endAngle:n,radius:e,width:2,step:1,stop:function(){100!=this.options.value&&(targetStep=0,lastDrag=0,$(".seq-holder.seq-"+currentSeq+" .circle").css("opacity",.05),$(".seq-holder.seq-"+currentSeq+" .slider").roundSlider("option",{value:0})),$(".rs-handle").removeClass("rs-focus")},drag:function(){targetStep=Math.max(Math.round(seqEndStep/100*this.getValue()),1);var e=Math.max(.05,Math.min(.9,this.getValue()/100)).toFixed(2);$(".seq-holder.seq-"+currentSeq+" .circle").css("opacity",e),3==currentSeq&&(scratchPlaying||(vinyl.currentTime=0,vinyl.play(),scratchPlaying=!0),vinyl.onended=function(){scratchPlaying=!1})},create:function(){$(".seq-holder.seq-"+currentSeq+" .slider-holder").addClass("active"),$(".seq-holder.seq-"+currentSeq+" .slider-holder .slider-circle").addClass("animate")}})}function releaseSlider(e){var t=e,n=setInterval(function(){targetStep=Math.max(Math.round(seqEndStep/100*t),1),t--,0>=t&&(clearInterval(n),targetStep=Math.max(Math.round(seqEndStep/100*0),1))},1e3/fps)}function seqEnd(){render(!1),seqActive=!1,seqEndCallback=null,step=1,targetStep=1,seqEndStep=2;var e=50;setTimeout(function(){$(".seq-holder.seq-"+currentSeq).removeClass("show")},e)}function checkLoginState(){FB.getLoginStatus(function(e){statusChangeCallback(e)})}function statusChangeCallback(e){"connected"!=e.status?FB.login(function(e){checkLoginState()},{scope:"public_profile,rsvp_event,user_events"}):(accessToken=e.authResponse.accessToken,fbUserMe())}function fbUserMe(){FB&&FB.api("/me?access_token="+accessToken,function(e){e&&!e.error&&(console.log(e),fbUserEvents(e.id),fbAttendEvent(e.id))})}function fbUserEvents(e){FB&&FB.api("/"+e+"/events?access_token="+accessToken,function(e){e&&console.log(e)})}function fbAttendEvent(e){FB&&FB.api("/1520701134916550?access_token="+accessToken,function(e){e&&console.log(e)})}function pad(e,t){for(var n=""+e;n.length<t;)n="0"+n;return n}function getAudioContext(){return new AudioContext||new webkitAudioContext||new mozAudioContext}var fps=25,frameVelocity=10,imagesLoaded=0,seqReady=!1,totalFrames=0,step=1,targetStep=1,currentSeq=1,video=null,videoLoop=null,callAudio=null,ringtone=null,vinyl=null,vinylSong=null,seqActive=!1,seqEndStep=1,seqEndCallback=null,stepSmoothing=5,canvas=null,context=null,bufferCanvas=null,bufferContext=null,contextW=0,contextH=0,contentResolution={width:1280,height:720},canvases=[],contexts=[],bufferCanvases=[],bufferContexts=[],videoLoaded=!1,loading=setInterval(function(){$(".loader span").html(Math.round(100/totalFrames*imagesLoaded)+"%"),seqReady&&videoLoaded&&clearInterval(loading)},100),isMobile=!1,isTablet=!1,seqCalled1=!1,seqStart1=19.855,seqEnd1=21.2,seqDuration1=seqEnd1-seqStart1,seqCalled2=!1,seqStart2=13.6,seqEnd2=13.6,seqDuration2=seqEnd2-seqStart2,seqCalled3=!1,seqStart3=28.2,seqEnd3=28.4,seqDuration3=seqEnd3-seqStart3,seqCalled4=!1,seqStart4=7.5,seqEnd4=7.5,seqDuration4=seqEnd4-seqStart4,seqCalled5=!1,seqStart5=20,seqEnd5=20,seqDuration5=seqEnd5-seqStart5,seqCalled6=!1,seqStart6=32,seqEnd6=32,seqDuration6=seqEnd6-seqStart6,requestId=0,seqEndCalled=!1;$(function(){isMobile||(callAudio=document.getElementById("call-audio"),ringtone=document.getElementById("ringtone"),video=document.getElementById("video-holder"),videoLoop=document.getElementById("video-loop"),vinyl=document.getElementById("vinyl"),vinylSong=document.getElementById("vinyl-song"),vinylSong.loop=!0,videoLoop.loop=!0,resizeVideo(),video.onended=function(){$("#video-holder").addClass("switch"),videoLoop.play(),$("#video-loop").addClass("switch")},video.addEventListener("timeupdate",function(){this.currentTime>=seqStart1&&!seqCalled1&&(currentSeq=1,seqEndCalled=!1,changeCanvas(currentSeq),render(!0),startSequence1()),isTablet?this.currentTime>=seqStart2&&!seqCalled2&&$(".vol-request").fadeOut():this.currentTime>=seqStart2&&!seqCalled2&&(seqEndCalled=!1,render(!0),startSequence2()),this.currentTime>=seqStart3&&!seqCalled3&&(seqEndCalled=!1,currentSeq=3,changeCanvas(currentSeq),render(!0),startSequence3()),isTablet||parseInt((25*this.currentTime).toFixed(0))>=210&&!seqCalled4&&(seqEndCalled=!1,render(!0),startSequence4()),parseInt((25*this.currentTime).toFixed(0))>=870&&!seqCalled5&&(seqEndCalled=!1,render(!0),startSequence5()),this.currentTime>=39&&!seqCalled6&&(seqEndCalled=!1,startSequence6(!1))})),$("img").on("dragstart",function(e){e.preventDefault()}),$(".mid-circle").bind("mousedown touchstart",function(){$(this).addClass("focus")}),$("body").bind("mouseup touchend",function(){$(".mid-circle").removeClass("focus")})}),$(window).load(function(){if(isMobile)var e=setInterval(function(){seqReady&&(seqEndCalled=!1,startSequence6(!0),$(".loader").fadeOut(300),clearInterval(e))},100);else $(".loader").fadeOut(300,function(){video.play()})}),$(window).resize(function(){resizeVideo()});var releaseValue=0,endSequence1=function(){$(".seq-holder.seq-1").removeClass("show"),video.play(),seqEnd()},endSequence2=function(){$(".seq-holder.seq-2 .mic-request").removeClass("animate"),$(".seq-holder.seq-2 .mic-ui").removeClass("animate").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){video.play(),seqEnd()})},skipSequence2=function(){$(".seq-holder.seq-2 .mic-request").hasClass("animate")?$(".seq-holder.seq-2 .mic-request").removeClass("animate").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){video.play(),seqEnd()}):$(".seq-holder.seq-2 .mic-ui").removeClass("animate").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){video.play(),seqEnd()})},endSequence3=function(){$(".seq-holder.seq-3").removeClass("show"),video.play(),seqEnd()},endSequence4=function(){video.play(),$(".vol-request").fadeOut(),seqEnd()},playingStep=!1,endSequence5=function(){seqEndCalled=!0,$(".seq-holder.seq-5 .test-holder").removeClass("active").one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){seqEnd()})},touchInterval=null,touchEndInterval=null,touchEndIntervalActive=!1,touched=!1,currentStepLength=0,seq=0,mobileSeq=new Array,mobileSeqStatus=new Array,endSequence6=function(){$(".seq-holder.seq-6").removeClass("show"),seqEnd()},decibelMeter=null,audioContext=getAudioContext(),BUFF_SIZE=16384,audioInput=null,microphone_stream=null,gain_node=null,script_processor_node=null,script_processor_fft_node=null,analyserNode=null,levelChecker=null,noiseAverage=0,noiseAverageHit=0,noiseTimeoutSet=!1,noiseTimeout=0,noise=0,oldMicVol=0,targetVol=0,currentVol=0,micUIInterval=!1,dragTimeout,lastDrag=0,dirChange=0,scratchPlaying=!1,accessToken=null;window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/fps)}}();